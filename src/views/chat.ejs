<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <title>Chat</title>
</head>

<body class="bSidebar d-flex align-items-center py-4 bg-body-tertiary">
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <form action="/timeline" method="get">
                <button class="sidebarButton"> <span class="material-symbols-outlined">home</span> Home</button>
            </form>
            <form action="/profile" method="get">
                <button class="sidebarButton"> <span class="material-symbols-outlined">person</span> Profile</button>
            </form>
            <form action="/search" method="get">
                <button class="sidebarButton"><span class="material-symbols-outlined">search</span> Search</button>
            </form>
            <form action="/chat" method="get">
                <button class="sidebarButton active"><span class="material-symbols-outlined">chat</span> Chat</button>
            </form>
            <form action="/login" method="get">
                <button class="sidebarButton"><span class="material-symbols-outlined">logout</span> Logout</button>
            </form>
        </div>

        <!-- Chat Section (Central Div) -->
        <div class="feed">
            <div class="feed_header">
                <h2>Chat</h2>
                <h5>Converse com seus amigos!</h5>
            </div>

            <!-- Mensagem inicial -->
            <div id="startMessage" class="text-center my-5">
                <h3>Selecione alguém online para iniciar uma conversa</h3>
            </div>

            <!-- Chat messages (escondido inicialmente) -->
            <div id="chatSection" class="chat_section d-none">
                <div id="chatWindow" class="chat_window">
                    <!-- As mensagens do chat vão aparecer aqui -->
                </div>

                <!-- Chat Input -->
                <div class="inputPost">
                    <form action="/chat/send" method="post" id="chatForm">
                        <input type="text" class="form-control" id="message" name="message"
                            placeholder="Digite sua mensagem..." required>
                        <button type="submit" class="postBox_post">Enviar</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Users Online -->
        <div class="users_sidebar">
            <div class="feed_header">
                <h3>Usuários Online</h3>
            </div>
            <ul class="users_list">
                <!-- A lista de usuários online será adicionada aqui -->
            </ul>
        </div>
    </div>

    <script>
        const socket = new WebSocket('ws://localhost:3357');
        let selectedUserId = null;
    
        // Exibir a seção do chat
        function showChatSection() {
            document.getElementById("startMessage").classList.add("d-none");
            document.getElementById("chatSection").classList.remove("d-none");
        }
    
        // Enviar login quando a conexão for aberta
        socket.onopen = () => {
            socket.send(JSON.stringify({ type: "login", userId: <%= userId %> })); // Passe o userId do servidor
        };
    
        // Enviar mensagens do formulário de chat
        document.getElementById('chatForm').addEventListener('submit', function (event) {
            event.preventDefault();
    
            const messageInput = document.getElementById('message');
            const messageText = messageInput.value.trim();
    
            if (messageText && selectedUserId) {
                const messageData = {
                    type: "message",
                    userId: <%= userId %>, // ID do usuário logado
                    receiverId: selectedUserId, // ID do usuário destinatário
                    message: messageText
                };
    
                // Enviar mensagem
                socket.send(JSON.stringify(messageData));
    
                // Adicionar mensagem localmente como enviada
                appendMessageToChatWindow("Você", messageData.message, true);
    
                // Limpar o campo de texto
                messageInput.value = '';
            }
        });
    
        socket.onmessage = function (event) {
        const messageData = JSON.parse(event.data);

        // Identificar se a mensagem foi enviada pelo usuário atual
        const isSentByCurrentUser = messageData.userId === <%= userId %>;

        // Adicionar mensagem ao chat
        appendMessageToChatWindow(
            isSentByCurrentUser ? "Você" : messageData.senderName || "Desconhecido",
            messageData.message,
            isSentByCurrentUser
        );
    };

    
        // Atualizar lista de usuários online
        function fetchUsersOnline() {
            fetch('/users-online')
                .then(response => response.json())
                .then(users => {
                    const usersList = document.querySelector('.users_list');
                    usersList.innerHTML = '';

                    users.forEach(user => {
                        const userItem = document.createElement('li');
                        userItem.textContent = user.user_name;
                        userItem.classList.add('user_item');
                        userItem.dataset.userId = user.id_user;

                        // Adiciona evento de clique para selecionar destinatário
                        userItem.addEventListener('click', () => {
                            selectedUserId = user.id_user;
                            showChatSection();
                        });

                        usersList.appendChild(userItem);
                    });
                })
                .catch(error => console.error('Erro ao buscar usuários online:', error));
        }

    
        // Atualiza a lista de usuários online a cada 10 segundos
        setInterval(fetchUsersOnline, 1000);
        fetchUsersOnline();
    
        // Função para adicionar mensagens ao chat
        function appendMessageToChatWindow(user, message, isSentByCurrentUser) {
            const chatWindow = document.getElementById('chatWindow');
            const messageElement = document.createElement('div');
    
            messageElement.textContent = `${user}: ${message}`;
            messageElement.classList.add('message');
    
            // Adicionar classes para alinhamento
            if (isSentByCurrentUser) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
            }
    
            chatWindow.appendChild(messageElement);
    
            // Rolar o chat para mostrar a mensagem mais recente
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
    

</body>

</html>